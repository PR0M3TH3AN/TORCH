# Test Log: Decompose scripts/agent/run-scheduler-cycle.mjs

## 1. File Size Report
Before: 1127 lines
After: 788 lines

## 2. Linting
Command: `npm run lint`
Output: No errors in modified files.

## 3. Unit/Integration Tests
Command: `node --test test/scheduler-lock-failure-schema.contract.test.mjs test/run-scheduler-cycle-memory-policy.test.mjs test/scheduler-preflight-lock.e2e.test.mjs test/scheduler-ratchet.test.mjs`

### Output
```
TAP version 13
# Subtest: fails required memory policy when retrieval/storage evidence is missing
ok 1 - fails required memory policy when retrieval/storage evidence is missing
  ---
  duration_ms: 757.539101
  type: 'test'
  ...
# Subtest: accepts required memory policy when markers or artifacts are produced
ok 2 - accepts required memory policy when markers or artifacts are produced
  ---
  duration_ms: 762.353236
  type: 'test'
  ...
# Subtest: records backend failure metadata when lock command exits with code 2
ok 3 - records backend failure metadata when lock command exits with code 2
  ---
  duration_ms: 907.42582
  type: 'test'
  ...
# Subtest: defers backend failures in non-strict mode and reuses idempotency key on successful retry
ok 4 - defers backend failures in non-strict mode and reuses idempotency key on successful retry
  ---
  duration_ms: 515.738251
  type: 'test'
  ...
# Subtest: fails after exceeding non-strict deferral budget
ok 5 - fails after exceeding non-strict deferral budget
  ---
  duration_ms: 169.270959
  type: 'test'
  ...
# Subtest: strict lock mode fails immediately without deferral
ok 6 - strict lock mode fails immediately without deferral
  ---
  duration_ms: 84.263333
  type: 'test'
  ...
# Subtest: skips lock health preflight by default when not enabled
ok 7 - skips lock health preflight by default when not enabled
  ---
  duration_ms: 351.440095
  type: 'test'
  ...
# Subtest: fails scheduler with preflight metadata when lock health preflight is enabled
ok 8 - fails scheduler with preflight metadata when lock health preflight is enabled
  ---
  duration_ms: 122.484853
  type: 'test'
  ...
# Subtest: categorizes unreadable prompt files as prompt_parse_error
ok 9 - categorizes unreadable prompt files as prompt_parse_error
  ---
  duration_ms: 87.191858
  type: 'test'
  ...
# Subtest: categorizes invalid prompt schema as prompt_schema_error
ok 10 - categorizes invalid prompt schema as prompt_schema_error
  ---
  duration_ms: 87.797569
  type: 'test'
  ...
# Subtest: categorizes handoff runtime failures as execution_error
ok 11 - categorizes handoff runtime failures as execution_error
  ---
  duration_ms: 324.626141
  type: 'test'
  ...
# Subtest: retries lock acquisition for backend error and succeeds on a later attempt
ok 12 - retries lock acquisition for backend error and succeeds on a later attempt
  ---
  duration_ms: 367.965729
  type: 'test'
  ...
# Subtest: stops retrying after configured lock backend retries are exhausted
ok 13 - stops retrying after configured lock backend retries are exhausted
  ---
  duration_ms: 93.241513
  type: 'test'
  ...
# Subtest: does not use backend retry flow for exit code 3 lock conflicts
ok 14 - does not use backend retry flow for exit code 3 lock conflicts
  ---
  duration_ms: 364.90421
  type: 'test'
  ...
# Subtest: scheduler lock backend failure artifact matches required frontmatter schema
ok 15 - scheduler lock backend failure artifact matches required frontmatter schema
  ---
  duration_ms: 99.881359
  type: 'test'
  ...
# Subtest: schema contract catches missing required lock-backend field
ok 16 - schema contract catches missing required lock-backend field
  ---
  duration_ms: 1.852952
  type: 'test'
  ...
# Subtest: schema contract catches misnamed lock-backend key
ok 17 - schema contract catches misnamed lock-backend key
  ---
  duration_ms: 0.591693
  type: 'test'
  ...
# Subtest: lock preflight e2e: successful lock writes completed status snapshot
ok 18 - lock preflight e2e: successful lock writes completed status snapshot
  ---
  duration_ms: 375.694252
  type: 'test'
  ...
# Subtest: lock preflight e2e: exit code 2 quorum failure persists failed backend status and prompt-not-started marker
ok 19 - lock preflight e2e: exit code 2 quorum failure persists failed backend status and prompt-not-started marker
  ---
  duration_ms: 88.901459
  type: 'test'
  ...
# Subtest: lock preflight e2e: non-lock failure exits failed without prompt parse/schema classification
ok 20 - lock preflight e2e: non-lock failure exits failed without prompt parse/schema classification
  ---
  duration_ms: 84.551615
  type: 'test'
  ...
# Subtest: Scheduler Ratchet Logic (Log Checking)
    # Subtest: excludes agents completed today (daily)
    ok 1 - excludes agents completed today (daily)
      ---
      duration_ms: 2.674164
      type: 'test'
      ...
    # Subtest: excludes agents completed this week (weekly)
    ok 2 - excludes agents completed this week (weekly)
      ---
      duration_ms: 0.457543
      type: 'test'
      ...
    # Subtest: combines locked and completed agents in exclusion list
    ok 3 - combines locked and completed agents in exclusion list
      ---
      duration_ms: 0.529591
      type: 'test'
      ...
    # Subtest: ignores logs when --ignore-logs is set
    ok 4 - ignores logs when --ignore-logs is set
      ---
      duration_ms: 0.486543
      type: 'test'
      ...
    # Subtest: handles missing log directory gracefully
    ok 5 - handles missing log directory gracefully
      ---
      duration_ms: 0.365618
      type: 'test'
      ...
    1..5
ok 21 - Scheduler Ratchet Logic (Log Checking)
  ---
  duration_ms: 5.944697
  type: 'suite'
  ...
# Subtest: Scheduler cycle ordering guarantees
    # Subtest: keeps optional preflight before lock-acquire and preserves handoff/artifact/validation/complete ordering
    ok 1 - keeps optional preflight before lock-acquire and preserves handoff/artifact/validation/complete ordering
      ---
      duration_ms: 11.091114
      type: 'test'
      ...
    # Subtest: includes lock backend failure metadata and classifier checkpoints
    ok 2 - includes lock backend failure metadata and classifier checkpoints
      ---
      duration_ms: 2.007641
      type: 'test'
      ...
    1..2
ok 22 - Scheduler cycle ordering guarantees
  ---
  duration_ms: 13.942915
  type: 'suite'
  ...
1..22
# tests 27
# suites 2
# pass 27
# fail 0
# cancelled 0
# skipped 0
# todo 0
# duration_ms 5077.329481
```
