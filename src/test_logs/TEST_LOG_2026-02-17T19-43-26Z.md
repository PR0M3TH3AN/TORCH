
> torch-lock@0.1.0 test:unit:lock-backend
> node --test test/lock-ops.test.mjs test/lock-ops-publish-retry.test.mjs

TAP version 13
# [publish:primary] Publishing to 1 relays (wss://relay-a)...
#   Published to 1/1 relays (required=1, timeout=200ms)
# [publish:primary] Publishing to 1 relays (wss://relay-a)...
# [publish:primary] Publishing to 1 relays (wss://relay-a)...
#   Published to 1/1 relays (required=1, timeout=200ms)
# [publish:primary] Publishing to 1 relays (wss://relay-a)...
# [publish:primary] Publishing to 1 relays (wss://relay-a)...
# [publish:primary] Publishing to 1 relays (wss://relay-a)...
# [publish:primary] Publishing to 1 relays (wss://relay-a)...
# (node:3973) ExperimentalWarning: The MockTimers API is an experimental feature and might change at any time
# (Use `node --trace-warnings ...` to show where the warning was created)
# Subtest: publishLock retry behavior
    # Subtest: succeeds immediately on first attempt without retries
    ok 1 - succeeds immediately on first attempt without retries
      ---
      duration_ms: 6.654526
      type: 'test'
      ...
    # Subtest: retries a transient failure then succeeds within retry budget with bounded jitter
    ok 2 - retries a transient failure then succeeds within retry budget with bounded jitter
      ---
      duration_ms: 4.073858
      type: 'test'
      ...
    # Subtest: returns terminal relay_publish_quorum_failure after exhausting retry budget
    ok 3 - returns terminal relay_publish_quorum_failure after exhausting retry budget
      ---
      duration_ms: 5.742571
      type: 'test'
      ...
    # Subtest: short-circuits non-retryable failures without extra attempts
    ok 4 - short-circuits non-retryable failures without extra attempts
      ---
      duration_ms: 2.299061
      type: 'test'
      ...
    1..4
ok 1 - publishLock retry behavior
  ---
  duration_ms: 20.363862
  type: 'suite'
  ...
# Subtest: lock-ops
    # Subtest: parseLockEvent
        # Subtest: parses a valid lock event correctly
        ok 1 - parses a valid lock event correctly
          ---
          duration_ms: 1.874948
          type: 'test'
          ...
        1..1
    ok 1 - parseLockEvent
      ---
      duration_ms: 2.822323
      type: 'suite'
      ...
# [publish:primary] Publishing to 2 relays (wss://primary-a, wss://primary-b)...
# [publish:primary] Publishing to 2 relays (wss://primary-a, wss://primary-b)...
#   Published to 2/2 relays (required=1, timeout=200ms)
# [publish:primary] Publishing to 1 relays (wss://primary-down)...
# [publish:primary] Publishing to 1 relays (wss://primary-down)...
# [publish:primary] Publishing to 1 relays (wss://primary-down)...
# [publish:primary] Publishing to 1 relays (wss://primary-bad)...
# [publish:primary] Publishing to 5 relays (relay-timeout, wss://dns, wss://tcp, wss://tls, wss://ws)...
# [publish:primary] Publishing to 2 relays (wss://relay-bad, wss://relay-ok)...
# {"event":"lock_publish_quorum_met","correlationId":"7d70b395-2145-4470-9f33-9b602a34792d","attemptId":"c0035955-5f07-4d6b-a450-e07811f00e2f","publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"requiredSuccesses":1,"timeoutMs":200,"retryTimeline":[{"publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"elapsedMs":1}],"totalElapsedMs":1}
#   Published to 1/2 relays (required=1, timeout=200ms)
# [publish:primary] Publishing to 1 relays (wss://primary-bad)...
# [publish:fallback] Publishing to 1 relays (wss://fallback-ok)...
# {"event":"lock_publish_quorum_met","correlationId":"239da9db-92a7-44f8-b694-52a4a6ddf437","attemptId":"12267c26-1926-4f5b-835b-f92682e5ffc4","publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"requiredSuccesses":1,"timeoutMs":200,"retryTimeline":[{"publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"elapsedMs":0}],"totalElapsedMs":0}
#   Published to 1/2 relays (required=1, timeout=200ms)
# [publish:primary] Publishing to 2 relays (wss://bad, wss://healthy)...
# {"event":"lock_publish_quorum_met","correlationId":"54df96c1-356d-40a2-a300-0a5fce94d1f9","attemptId":"72e3fd52-0c75-4f3f-a43f-241ed8d973e1","publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"requiredSuccesses":1,"timeoutMs":200,"retryTimeline":[{"publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"elapsedMs":0}],"totalElapsedMs":0}
#   Published to 1/2 relays (required=1, timeout=200ms)
# [publish:primary] Publishing to 2 relays (wss://healthy, wss://bad)...
# {"event":"lock_publish_quorum_met","correlationId":"35e05397-38ab-4fd5-b979-9f731dc5765a","attemptId":"c6410080-1244-4f4b-9139-dbb85187b441","publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"requiredSuccesses":1,"timeoutMs":200,"retryTimeline":[{"publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"elapsedMs":0}],"totalElapsedMs":0}
#   Published to 1/2 relays (required=1, timeout=200ms)
# [publish:primary] Publishing to 2 relays (wss://healthy, wss://bad)...
# {"event":"lock_publish_quorum_met","correlationId":"e6f1916c-879a-4ed2-953e-7a519c11d857","attemptId":"1aa9c36c-8755-45ca-9fe6-6a89f883c152","publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"requiredSuccesses":1,"timeoutMs":200,"retryTimeline":[{"publishAttempt":1,"successCount":1,"relayAttemptedCount":2,"elapsedMs":0}],"totalElapsedMs":0}
#   Published to 1/2 relays (required=1, timeout=200ms)
# [publish:primary] Publishing to 1 relays (wss://healthy)...
# {"event":"lock_publish_quorum_met","correlationId":"56c8195a-74eb-4b72-a495-3e1efcb4a3f0","attemptId":"d2e0b655-7115-4f61-91fc-139dc5ec9db4","publishAttempt":1,"successCount":1,"relayAttemptedCount":1,"requiredSuccesses":1,"timeoutMs":200,"retryTimeline":[{"publishAttempt":1,"successCount":1,"relayAttemptedCount":1,"elapsedMs":0}],"totalElapsedMs":0}
#   Published to 1/1 relays (required=1, timeout=200ms)
# [publish:primary] Publishing to 2 relays (wss://primary-a, wss://primary-b)...
# [publish:fallback] Publishing to 1 relays (wss://fallback-healthy)...
# {"event":"lock_publish_quorum_met","correlationId":"94251c93-ebf1-481d-8fb5-c8a73bdf0a20","attemptId":"533fb740-98ec-4358-9d32-78c8b0ac72a4","publishAttempt":1,"successCount":1,"relayAttemptedCount":3,"requiredSuccesses":1,"timeoutMs":200,"retryTimeline":[{"publishAttempt":1,"successCount":1,"relayAttemptedCount":3,"elapsedMs":0}],"totalElapsedMs":0}
#   Published to 1/3 relays (required=1, timeout=200ms)
    # Subtest: queryLocks
        # Subtest: falls back to fallback relays when primary query fails
        ok 1 - falls back to fallback relays when primary query fails
          ---
          duration_ms: 27.235965
          type: 'test'
          ...
        1..1
    ok 2 - queryLocks
      ---
      duration_ms: 27.514651
      type: 'suite'
      ...
    # Subtest: publishLock
        # Subtest: retries transient failures and succeeds on a later attempt
        not ok 1 - retries transient failures and succeeds on a later attempt
          ---
          duration_ms: 6.53189
          type: 'test'
          location: '/app/test/lock-ops.test.mjs:78:5'
          failureType: 'testCodeFailure'
          error: |-
            Expected values to be strictly deep-equal:
            + actual - expected

              {
            +   attemptId: '52c2baa6-8ff8-4f42-b6b3-ead606942315',
            +   correlationId: '6428aa2b-60f0-40a5-b385-525fc25c46b0',
            -   attemptId: 'attempt-1',
            -   correlationId: 'corr-1',
                elapsedMs: 1,
                errorCategory: 'connection_reset',
                event: 'lock_publish_retry',
                nextDelayMs: 250,
                publishAttempt: 1,

          code: 'ERR_ASSERTION'
          name: 'AssertionError'
          expected:
            event: 'lock_publish_retry'
            correlationId: 'corr-1'
            attemptId: 'attempt-1'
            publishAttempt: 1
            relayUrl: 'wss://primary-a'
            errorCategory: 'connection_reset'
            elapsedMs: 1
            nextDelayMs: 250
          actual:
            event: 'lock_publish_retry'
            correlationId: '6428aa2b-60f0-40a5-b385-525fc25c46b0'
            attemptId: '52c2baa6-8ff8-4f42-b6b3-ead606942315'
            publishAttempt: 1
            relayUrl: 'wss://primary-a'
            errorCategory: 'connection_reset'
            elapsedMs: 1
            nextDelayMs: 250
          operator: 'deepStrictEqual'
          stack: |-
            TestContext.<anonymous> (file:///app/test/lock-ops.test.mjs:124:14)
            async Test.run (node:internal/test_runner/test:1054:7)
            async Promise.all (index 0)
            async Suite.run (node:internal/test_runner/test:1442:7)
            async Suite.processPendingSubtests (node:internal/test_runner/test:744:7)
          ...
        # Subtest: fails after retry budget is exhausted for persistent transient failures
        ok 2 - fails after retry budget is exhausted for persistent transient failures
          ---
          duration_ms: 2.875565
          type: 'test'
          ...
        # Subtest: fails without retry for persistent validation failures
        ok 3 - fails without retry for persistent validation failures
          ---
          duration_ms: 1.360655
          type: 'test'
          ...
        # Subtest: includes per-relay reason categories and retry metadata in failure diagnostics
        ok 4 - includes per-relay reason categories and retry metadata in failure diagnostics
          ---
          duration_ms: 2.145677
          type: 'test'
          ...
        # Subtest: returns success when mixed relay outcomes still satisfy quorum
        ok 5 - returns success when mixed relay outcomes still satisfy quorum
          ---
          duration_ms: 1.586006
          type: 'test'
          ...
        # Subtest: uses fallback relays to satisfy min success quorum
        ok 6 - uses fallback relays to satisfy min success quorum
          ---
          duration_ms: 1.059862
          type: 'test'
          ...
        # Subtest: quarantines repeatedly failing relays and still reaches quorum with one healthy relay
        ok 7 - quarantines repeatedly failing relays and still reaches quorum with one healthy relay
          ---
          duration_ms: 2.500909
          type: 'test'
          ...
        # Subtest: uses fallback and min active pool to reintroduce quarantined relay when needed
        ok 8 - uses fallback and min active pool to reintroduce quarantined relay when needed
          ---
          duration_ms: 1.073546
          type: 'test'
          ...
        1..8
    not ok 3 - publishLock
      ---
      duration_ms: 19.967883
      type: 'suite'
      location: '/app/test/lock-ops.test.mjs:77:3'
      failureType: 'subtestsFailed'
      error: '1 subtest failed'
      code: 'ERR_TEST_FAILURE'
      ...
    1..3
not ok 2 - lock-ops
  ---
  duration_ms: 52.981447
  type: 'suite'
  location: '/app/test/lock-ops.test.mjs:10:1'
  failureType: 'subtestsFailed'
  error: '1 subtest failed'
  code: 'ERR_TEST_FAILURE'
  ...
1..2
# tests 14
# suites 5
# pass 13
# fail 1
# cancelled 0
# skipped 0
# todo 0
# duration_ms 196.37029
