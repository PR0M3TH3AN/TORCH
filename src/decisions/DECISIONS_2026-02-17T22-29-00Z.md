# Decisions: Decompose scripts/agent/run-scheduler-cycle.mjs

## Rationale
The `scripts/agent/run-scheduler-cycle.mjs` file had grown to 1127 lines, making it the largest source file in the repository. It contained mixed responsibilities: process management, logging, locking logic, and configuration parsing.

We decided to extract cohesive blocks to improve maintainability and testability.

## Extracted Modules

### 1. `scripts/agent/scheduler-utils.mjs`
**Why:** Many utility functions (`runCommand`, `getSafeEnv`, `parseJson*`, `sleep`, etc.) were cluttering the main logic. These are generic and can be reused or at least moved out of the way.
**Changes:** Moved low-level helpers here. Exported them.

### 2. `scripts/agent/scheduler-lock.mjs`
**Why:** The locking logic (`acquireLockWithRetry`, failure classification, remediation) is complex and distinct from the core scheduler loop. It forms a "locking service" conceptual block.
**Changes:** Moved `acquireLockWithRetry`, `classifyLockBackendError`, `buildLockBackendRemediation`, `runLockHealthPreflight`, and `summarizeLockFailureReasons` here.

## Baseline Update
The `scripts/check-file-size.mjs` script does not currently support an `--update` flag or contain a `BASELINE` object as referenced in the agent prompt. Therefore, no code change was made to that script. However, the file size reduction was verified manually:
- Original: 1127 lines
- New: 788 lines
- Reduction: 339 lines (exceeds 200 line target).

## Test Updates
The E2E tests (`test/scheduler-preflight-lock.e2e.test.mjs`, `test/run-scheduler-cycle-memory-policy.test.mjs`, `test/scheduler-lock-failure-schema.contract.test.mjs`) required updates to copy the new module files (`scheduler-utils.mjs`, `scheduler-lock.mjs`) into the test fixture directory.
The unit test `test/scheduler-ratchet.test.mjs` was updated to look for `classifyLockBackendError` in the new `scheduler-lock.mjs` file instead of the main script.
